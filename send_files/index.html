<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <form
      action="http://localhost:4000/api"
      method="POST"
      enctype="multipart/form-data"
      id="uploadForm"
    >
      <input type="file" name="file" id="fileToUpload" multiple accept="*/*" />
      <input type="number" name="w" />
      <input type="checkbox" name="thumb" />
      <button type="submit">Upload</button>
    </form>
    <p style="display: block" id="preview"></p>
    <p id="response"></p>

    <script>
      const input = document.querySelector("#fileToUpload"),
        preview = document.querySelector("#preview");

      input.addEventListener("change", previewer, false);
      function previewer() {
        for (let file of this.files) {
          const img = document.createElement("img"),
            src = URL.createObjectURL(file);

          img.src = src;
          img.style.display = "inline-block";
          img.width = "200";
          img.height = "200";
          preview.append(img);
        }
      }

      let form = ({ action, method } = document.forms[0]);

      form.onsubmit = async (e) => {
        e.preventDefault();
        let fd = new FormData(form);
        // let i = 0,
        //   fd = new FormData();

        // for (let f of e.target[0].files) {
        //   fd.append(`file-${i}`, f, f.name);
        //   i++;
        // }

        // fd.append("w", JSON.stringify({ w: e.target[1].value }));
        // fd.append("thumb", JSON.stringify({ thumb: e.target[2].value }));
        return post({ url: action, fd });
      };

      async function post({ url, fd }) {
        for (let entry of fd.entries()) {
          console.log(entry);
        }
        console.log(fd.entries());
        try {
          const request = await fetch(url, { method, body: fd });

          if (request.ok) {
            const response = await request.json();
            return setResponse(response);
          } else {
            throw new Error("File upload failed");
          }
        } catch (error) {
          console.error("Error uploading file:", error);
        }
      }

      function setResponse(response) {
        preview.innerHTML = "";
        form.reset();
        document.querySelector("#response").innerText =
          JSON.stringify(response);
      }
    </script>
    <!-- <form id="f" action="http://localhost:4000/api" method="POST" enctype="multipart/form-data">
        <input type="file" name="file" multiple />
      </form>
      <button form="f">Upload</button>
      <script>
        const form = ({ method, action } = document.forms[0]);
        form.onsubmit=  async (e) => {
          e.preventDefault();
          return fetch(new URL(action), { method, body: new FormData(form) })
            .then((r) => r.json())
            .then(console.log);
        }); 
      </script>-->
  </body>
</html>
